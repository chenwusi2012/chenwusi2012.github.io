<!DOCTYPE html>
<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style> 
circle {stroke: black;} 
#tooltip {
    opacity: 0;
    position: absolute;
    text-align: center;
    background: white;
    border: 10px;
}
</style>
<body onload='init()'>
<h1>Fuel Efficiency Study</h1>
<div>
    <button onclick="drawGasoline4()">Gasoline 4 Cylinders</button>
    <button onclick="drawGasoline6()">Gasoline 6 Cylinders</button>
    <button onclick="drawGasoline8()">Gasoline 8 Cylinders</button>
    <button onclick="drawDiesel()">Diesel</button>
    <button onclick="drawElectricity()">Hybrid</button>
</div>
<h2 id="currentPlot"></h2>
<div>
    <p id="takeaway"></p>
</div>
<div>
    <svg id="svg1" width=700 height=700></svg>
    <svg id="legend" height=700 width=200></svg>
</div>

<div id="tooltip"></div>
<script>
const height = 550;
const width = 550;
const margin = 75;
const radius = 12;
var data;
var tooltip = d3.select("#tooltip").style('font-size', '14px');

async function init() {
data = await d3.csv("/cars2017-2.csv");
drawGasoline4();
drawLegend();
}

function drawGasoline4() {
    d3.select("#svg1").selectAll('*').remove();
    document.getElementById("currentPlot").innerHTML = "Cars with 4-Cylinder Engines";
    drawChart("Gasoline", 4);
}

function drawGasoline6() {
    d3.select("#svg1").selectAll('*').remove();
    document.getElementById("currentPlot").innerHTML = "Cars with 6-Cylinder Engines";
    drawChart("Gasoline", 6);
}

function drawGasoline8() {
    d3.select("#svg1").selectAll('*').remove();
    document.getElementById("currentPlot").innerHTML = "Cars with 8-Cylinder Engines";
    drawChart("Gasoline", 8);
}

function drawDiesel() {
    d3.select("#svg1").selectAll('*').remove();
    document.getElementById("currentPlot").innerHTML = "Cars with Diesel Engines";
    drawChart("Diesel", 0);
}

function drawElectricity() {
    d3.select("#svg1").selectAll('*').remove();
    document.getElementById("currentPlot").innerHTML = "Cars with Hybrid Power";
    drawChart("Electricity", 0);
}

function drawChart(fuel, cylinder) {
    var data2;
    if (fuel == "Gasoline")
    {
        data2 = data.filter(function(d){ return (d.Fuel == fuel && d.EngineCylinders == cylinder) });
    }
    else
    {
        data2 = data.filter(function(d){ return d.Fuel == fuel});
    }

    var cityMin = d3.min(data2, function(d) { return +d.AverageCityMPG; });
    var cityMax = d3.max(data2, function(d) { return +d.AverageCityMPG; });
    var highMin = d3.min(data2, function(d) { return +d.AverageHighwayMPG; });
    var highMax = d3.max(data2, function(d) { return +d.AverageHighwayMPG; });
    var minBound = Math.min(cityMin, highMin);
    var maxBound = Math.max(cityMax, highMax);
    var x = d3.scaleLinear().domain([cityMin - 2, cityMax + 2]).range([0,width]);
    var y = d3.scaleLinear().domain([highMin - 2, highMax + 2]).range([height,0]);
    var color = d3.scaleOrdinal().domain(["USA", "Europe", "Asia" ]).range([ "#440154ff", "#21908dff", "#fde725ff"])

d3.select("#svg1")
.attr("width", width + 2 * margin)
.attr("height", height + 2 * margin)
.append("g")
.attr("transform", "translate("+margin+","+margin+")")
.selectAll("circle")
.data(data2)
.enter()
.append("circle")
.attr("cx",function(d,i) {return x(d.AverageCityMPG);})
.attr("cy",function(d,i) {return y(d.AverageHighwayMPG);})
.attr("r", radius)
.style("fill", function (d) { return color(d.Region) } )
.on("mouseover", function(d,i) {
        tooltip.style("opacity", 1)
               .style("left",(d3.event.pageX)+"px")
               .style("top",(d3.event.pageY)+"px")
               .style("text-anchor", "left")
               .html("Make: " + d.Make + "<br>" + "Cylinder: " + d.EngineCylinders +  "<br>" + " Average City: " + d.AverageCityMPG + "<br>" + " Average Highway: " + d.AverageHighwayMPG);
    })
.on("mouseout", function() { tooltip.style("opacity", 0) });

d3.select("#svg1").append("g")
.style("font", "14px times")
.attr("transform", "translate("+margin+","+margin+")")
.call(d3.axisLeft(y));

d3.select("#svg1").append("g")
.style("font", "14px times")
.attr("transform", "translate("+margin+","+(height+margin)+")")
.call(d3.axisBottom(x));

d3.select("#svg1").append("text")             
.attr("transform","translate(" + (margin+width/2) + " ," + (height + margin + 40) + ")")
.style("text-anchor", "middle")
.text("Average City MPG");

d3.select("#svg1").append("text")
.attr("transform", "rotate(-90)")
.attr("y", 0 - margin.left)
.attr("x",0 - (height / 2))
.attr("dy", "1em")
.style("text-anchor", "middle")
.text("Average Highway MPG");  

var lineStart = Math.max(cityMin, highMin) - 2;
var lineEnd = Math.min(cityMax, highMax) + 2;
d3.select("#svg1")
.append("g")
.attr("transform", "translate("+margin+","+margin+")")
.append('line')
.attr('x1', x(lineStart))
.attr('y1', y(lineStart))
.attr('x2', x(lineEnd))
.attr('y2', y(lineEnd))
.attr('stroke', 'red')
.style("stroke-dasharray", ("20, 10"))
.style("stroke-width", 5)
.style("stroke-opacity", 0.5);

d3.select("#svg1")
.append("g")
.attr("transform", "translate("+margin+","+margin+")")
.append('text')
.attr('x', x(lineEnd) - 150)
.attr('y', y(lineEnd) - 30)
.attr('stroke', 'red')
.attr('width', 100)
.attr('height',100)
.style("font-size", 14)
.text("Equal Fuel Efficiency");

d3.select("#svg1")
.append("g")
.attr("transform", "translate("+margin+","+margin+")")
.append('text')
.attr('x', x(lineEnd) - 150)
.attr('y', y(lineEnd) - 10)
.attr('stroke', 'red')
.attr('width', 100)
.attr('height',100)
.style("font-size", 15)
.text("(City MPG = Highway MPG)");

if (fuel == "Gasoline" && cylinder == 4) {
    d3.select("#svg1")
    .append("g")
    .attr("transform", "translate("+margin+","+margin+")")
    .append('rect')
    .attr('x', x(24.5))
    .attr('y', y(39))
    .attr('width', Math.abs(x(24.5)-x(40)))
    .attr('height', Math.abs(y(39)-y(33.5)))
    .attr('stroke', 'blue')
    .style("stroke-dasharray", ("20, 10"))
    .style("stroke-width", 5)
    .style("stroke-opacity", 0.5)
    .style("fill", "none");

    d3.select("#svg1")
    .append("g")
    .attr("transform", "translate("+margin+","+margin+")")
    .append('text')
    .attr('x', x(35))
    .attr('y', y(32.7))
    .attr('stroke', 'blue')
    .style("font-size", 15)
    .text("Asia cars is more");

    d3.select("#svg1")
    .append("g")
    .attr("transform", "translate("+margin+","+margin+")")
    .append('text')
    .attr('x', x(35))
    .attr('y', y(32.1))
    .attr('stroke', 'blue')
    .style("font-size", 15)
    .text("fuel efficient");
}


}



function drawLegend() {
var svg = d3.select("#legend")
var yPos = 200;
svg.append("circle").attr("cx",30).attr("cy",yPos).attr("r", radius).style("fill", "#440154ff");
svg.append("circle").attr("cx",30).attr("cy",yPos+30).attr("r", radius).style("fill", "#21908dff");
svg.append("circle").attr("cx",30).attr("cy",yPos+60).attr("r", radius).style("fill", "#fde725ff");
svg.append("text").attr("x", 50).attr("y", yPos).text("USA Brands").style("font-size", "15px").attr("alignment-baseline","middle");
svg.append("text").attr("x", 50).attr("y", yPos+30).text("Europe Brands").style("font-size", "15px").attr("alignment-baseline","middle");
svg.append("text").attr("x", 50).attr("y", yPos+60).text("Asia Brands").style("font-size", "15px").attr("alignment-baseline","middle");
svg.append('rect')
  .attr('x', 0)
  .attr('y', yPos-30)
  .attr('width', 180)
  .attr('height', 120)
  .attr('stroke', 'black')
  .style("fill", "none");

}
</script>
</body>
</html>